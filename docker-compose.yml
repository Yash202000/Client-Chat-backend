
version: '3.8'

x-minio-common: &minio-common
  image: quay.io/minio/minio:latest
  command: server --console-address ":9090" /mnt/data
  ports:
    - "9000:9000"
    - "9090:9090"
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
    interval: 30s
    timeout: 20s
    retries: 3

services:
  zipkin:
    image: openzipkin/zipkin
    ports:
      - "9411:9411"
    depends_on: [otel-collector]
    restart: always
    
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.111.0
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ${PWD}/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    restart: always

  chroma:
    image: chromadb/chroma
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - CHROMA_OPEN_TELEMETRY__ENDPOINT=http://otel-collector:4317/
      - CHROMA_OPEN_TELEMETRY__SERVICE_NAME=chroma
    restart: always
    depends_on:
      - otel-collector
      - zipkin

  minio1:
    <<: *minio-common
    hostname: minio1
    restart: always
    volumes:
      - type: bind
        source: /mnt/data/agentconnect
        target: /mnt/data
      - type: bind
        source: /etc/default/minio
        target: /etc/config.env

  db:
    image: postgres:15
    restart: always
    healthcheck: { test: ["CMD-SHELL", "pg_isready -U agentconnect"], interval: 10s, timeout: 5s, retries: 5 }
    volumes:
      - agentconnect_db:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER:     agentconnect
      POSTGRES_PASSWORD: agentconnect

  # frontend:
  #   # IMPORTANT: Replace 'your-frontend-image:latest' with the actual name and tag of your built Docker image.
  #   image: yashplg/agentconnect-frontend:v1.7
  #   container_name: frontend_service
  #   ports:
  #     # Maps port 8080 on your local machine to port 80 in the container.
  #     # You can access your app at http://localhost:8080
  #     - "8080:80"
  #   environment:
  #     # These variables are now used at runtime by your container's startup script.
  #     - VITE_BACKEND_URL=https://agentconnect.com
  #     - VITE_LIVEKIT_URL=wss://intersee-isrh22yh.livekit.cloud
  #     - VITE_VOICE_ENGINE_URL=http://localhost:8001
  #   restart: always

  # Documentation Service - Docusaurus
  docs:
    build:
      context: ../docs
      dockerfile: Dockerfile
      target: development  # Use 'production' for prod deployment
    container_name: agentconnect_docs
    ports:
      - "3001:3000"  # Dev server on port 3001
    volumes:
      - ../docs:/app  # Mount docs folder for hot reload
      - /app/node_modules  # Prevent overwriting node_modules
    environment:
      - NODE_ENV=development
    restart: unless-stopped
    # For production, uncomment below and comment above:
    # docs-prod:
    #   build:
    #     context: ../docs
    #     dockerfile: Dockerfile
    #     target: production
    #   container_name: agentconnect_docs
    #   ports:
    #     - "3001:80"
    #   restart: always


volumes:
  chroma_data:
  agentconnect_db:
